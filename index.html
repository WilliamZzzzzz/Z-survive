<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æœ«æ—¥æ–‡å­—ç”Ÿå­˜ Â· å®¶å…· & åˆ¶é€ æ‰©å±•ç‰ˆ</title>
  <style>
    body {
      background: #0b0f19;
      color: #e5e7eb;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      display: flex;
      justify-content: center;
    }
    .game {
      max-width: 960px;
      padding: 16px;
      width: 100%;
    }
    h1 {
      font-size: 22px;
      margin: 8px 0 4px;
    }
    .subtitle {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }
    .status {
      background: #020617;
      border-radius: 6px;
      padding: 8px;
      font-size: 13px;
      line-height: 1.6;
      border: 1px solid #1f2933;
      margin-bottom: 10px;
    }
    .status span.label {
      color: #9ca3af;
      margin-right: 4px;
    }
    #log {
      background: #020617;
      border-radius: 6px;
      padding: 10px;
      min-height: 140px;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.7;
      border: 1px solid #1f2933;
      margin-bottom: 10px;
    }
    .choices {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    button {
      background: #111827;
      color: #e5e7eb;
      border-radius: 999px;
      border: 1px solid #374151;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.1s, transform 0.05s, border-color 0.1s;
    }
    button:hover {
      background: #1f2937;
      border-color: #4b5563;
    }
    button:active {
      transform: scale(0.97);
    }
    .columns {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      gap: 10px;
    }
    @media (max-width: 800px) {
      .columns {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #020617;
      border-radius: 6px;
      padding: 8px;
      border: 1px solid #1f2933;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .panel h2 {
      font-size: 14px;
      margin: 0 0 4px;
    }
    .quality-gray { color: #9ca3af; }
    .quality-white { color: #e5e7eb; }
    .quality-green { color: #4ade80; }
    .quality-blue { color: #38bdf8; }
    .small {
      font-size: 11px;
      color: #6b7280;
      margin-top: 6px;
    }

    /* èƒŒåŒ…ç½‘æ ¼ */
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 4px;
      margin: 4px 0;
    }
    .inventory-item {
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 4px;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 11px;
      text-align: center;
      transition: background 0.1s, border-color 0.1s, transform 0.05s;
    }
    .inventory-item:hover {
      background: #111827;
      border-color: #4b5563;
      transform: translateY(-1px);
    }
    .inventory-icon {
      font-size: 16px;
      margin-bottom: 2px;
    }
    .inv-detail {
      font-size: 11px;
      color: #9ca3af;
      min-height: 32px;
      border-top: 1px solid #111827;
      padding-top: 4px;
      margin-top: 4px;
    }

    /* å®¶å…·ç½‘æ ¼ */
    .furniture-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
    }
    .furniture-item {
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 4px;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 11px;
      text-align: center;
      cursor: pointer;
      transition: background 0.1s, border-color 0.1s, transform 0.05s;
    }
    .furniture-item:hover {
      background: #111827;
      border-color: #4b5563;
      transform: translateY(-1px);
    }
    .furniture-locked {
      opacity: 0.5;
      color: #6b7280;
      border-color: #374151;
      cursor: default;
    }
    .furniture-locked:hover {
      background: #020617;
      transform: none;
    }

    /* åˆ¶é€ åˆ†ç±»ç½‘æ ¼ */
    .craft-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
    }
    .craft-item {
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 4px;
      min-height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-size: 11px;
      text-align: center;
      cursor: pointer;
      transition: background 0.1s, border-color 0.1s, transform 0.05s;
    }
    .craft-item:hover {
      background: #111827;
      border-color: #4b5563;
      transform: translateY(-1px);
    }
    .craft-item-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .craft-item-desc {
      color: #9ca3af;
      font-size: 10px;
    }

    /* åœ°å›¾ç•Œé¢ & åˆ¶é€ é…æ–¹å¡ç‰‡å…±ç”¨ */
    .map-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    .map-location {
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 6px;
      background: #020617;
      cursor: pointer;
      transition: background 0.1s, border-color 0.1s, transform 0.05s;
      font-size: 12px;
    }
    .map-location:hover {
      background: #111827;
      border-color: #4b5563;
      transform: translateY(-1px);
    }
    .map-location-name {
      font-weight: 600;
      margin-bottom: 2px;
    }
  </style>
</head>
<body>

<!-- åŸºåœ°ç•Œé¢ -->
<div class="game" id="homeScreen">
  <h1>æœ«æ—¥æ–‡å­—ç”Ÿå­˜</h1>
  <div class="subtitle">ç¬¬ä¸€æ¬¡æ€»ç»“æ‰©å±•ç‰ˆ Â· æ—¶é—´ + çŠ¶æ€ï¼ˆé¥¥æ¸´/ä½“åŠ›ï¼‰+ æ­¦å™¨å“è´¨ + å®¶å…· + åˆ¶é€  + åœ°å›¾</div>

  <div class="status" id="status"></div>
  <div id="log"></div>

  <div class="columns">
    <div>
      <div class="panel">
        <h2>è¡ŒåŠ¨</h2>
        <div class="choices" id="choices"></div>
      </div>

      <div class="panel" id="furniturePanel"></div>
      <div class="panel" id="craftPanel"></div>
    </div>

    <div>
      <div class="panel" id="weaponPanel"></div>
      <div class="panel" id="inventoryPanel"></div>
      <div class="panel" id="metaPanel"></div>
    </div>
  </div>

  <div class="small">
    æç¤ºï¼šè¿™æ˜¯åŸå‹ï¼Œä¸æ˜¯æœ€ç»ˆæ•ˆæœã€‚<br>
    å½“å‰ç‰ˆæœ¬å®ç°ï¼šæ—¶é—´ç³»ç»Ÿã€çŠ¶æ€ï¼ˆé¥±è…¹/æ°´åˆ†/ä½“åŠ›ï¼‰ã€åŸºåœ°ç•Œé¢ã€å®¶å…·ç½‘æ ¼ã€åˆ¶é€ åˆ†ç±»ç•Œé¢ã€æ¢ç´¢åœ°å›¾ç•Œé¢ã€æ¢ç´¢/æˆ˜æ–—ã€æ­¦å™¨å“è´¨ï¼ˆç°/ç™½/ç»¿/è“ï¼‰ã€è€ä¹…ã€åˆ¶é€ é…æ–¹ã€èƒŒåŒ…ç½‘æ ¼ã€‚
  </div>
</div>

<!-- æ¢ç´¢åœ°å›¾ç•Œé¢ -->
<div class="game" id="mapScreen" style="display:none;">
  <h1>æ¢ç´¢åœ°å›¾</h1>
  <div class="subtitle">é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹å‰å¾€æ¢ç´¢ã€‚è·ç¦»è¶Šè¿œè€—æ—¶è¶Šé•¿ï¼Œæ™šä¸Š 21:00 ä¹‹åå±é™©åº¦ä¼šæå‡ã€‚</div>

  <div class="status" id="mapStatus"></div>

  <div class="panel">
    <h2>åŒºåŸŸé€‰æ‹©</h2>
    <div class="map-grid">
      <div class="map-location" onclick="selectLocation('residential')">
        <div class="map-location-name">ğŸ  é™„è¿‘ä½å®…åŒº</div>
        <div>è·ç¦»ï¼šè¿‘ï¼ˆ40 åˆ†é’Ÿï¼‰</div>
        <div>èµ„æºï¼šåŸºç¡€é£Ÿç‰© / ææ–™</div>
      </div>
      <div class="map-location" onclick="selectLocation('supermarket')">
        <div class="map-location-name">ğŸª åºŸå¼ƒè¶…å¸‚</div>
        <div>è·ç¦»ï¼šä¸­ï¼ˆ60 åˆ†é’Ÿï¼‰</div>
        <div>èµ„æºï¼šé£Ÿç‰© / æ°´</div>
      </div>
      <div class="map-location" onclick="selectLocation('hospital')">
        <div class="map-location-name">ğŸ¥ åºŸå¼ƒåŒ»é™¢</div>
        <div>è·ç¦»ï¼šä¸­è¿œï¼ˆ75 åˆ†é’Ÿï¼‰</div>
        <div>èµ„æºï¼šåŒ»ç–—ç‰©èµ„</div>
      </div>
      <div class="map-location" onclick="selectLocation('factory')">
        <div class="map-location-name">ğŸ­ å·¥ä¸šåŒº</div>
        <div>è·ç¦»ï¼šè¿œï¼ˆ90 åˆ†é’Ÿï¼‰</div>
        <div>èµ„æºï¼šé‡‘å± / ææ–™</div>
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>åœ°ç‚¹ä¿¡æ¯</h2>
    <div id="mapLocationDetail" style="min-height:60px; font-size:13px; white-space:pre-wrap;">
      ç‚¹å‡»å·¦ä¾§ä»»æ„åœ°ç‚¹æŸ¥çœ‹è¯¦æƒ…ã€‚
    </div>
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button onclick="startTravel()">ğŸš¶ å‡ºå‘å‰å¾€</button>
      <button onclick="backToBase()">â¬…ï¸ è¿”å›åŸºåœ°</button>
    </div>
  </div>
</div>

<!-- åˆ¶é€ åˆ†ç±»å­ç•Œé¢ -->
<div class="game" id="craftScreen" style="display:none;">
  <h1 id="craftTitle">åˆ¶é€ </h1>
  <div class="subtitle" id="craftSubtitle">é€‰æ‹©ä¸€ä¸ªé…æ–¹è¿›è¡Œåˆ¶ä½œã€‚</div>

  <div class="status" id="craftStatus"></div>

  <div class="panel">
    <h2 id="craftCategoryName">é…æ–¹</h2>
    <div id="craftList"></div>
  </div>

  <div class="panel">
    <h2>è¯´æ˜ / ç»“æœ</h2>
    <div id="craftDetail" style="min-height:60px; font-size:13px; white-space:pre-wrap;">
      é€‰æ‹©ä¸€ä¸ªé…æ–¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å¹¶è¿›è¡Œåˆ¶ä½œã€‚
    </div>
    <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
      <button onclick="backFromCraft()">â¬…ï¸ è¿”å›åŸºåœ°</button>
    </div>
  </div>
</div>

<script>
  // -----------------------
  // å“è´¨å®šä¹‰
  // -----------------------
  const Qualities = {
    gray:   { name: 'ç°è‰²',  colorClass: 'quality-gray',  atkBonus: 0,  durBonus: 0 },
    white:  { name: 'ç™½è‰²',  colorClass: 'quality-white', atkBonus: 1,  durBonus: 4 },
    green:  { name: 'ç»¿è‰²',  colorClass: 'quality-green', atkBonus: 2,  durBonus: 8 },
    blue:   { name: 'è“è‰²',  colorClass: 'quality-blue',  atkBonus: 3,  durBonus: 12 }
  };

  function rollDropQuality() {
    const r = Math.random();
    if (r < 0.4) return 'gray';
    if (r < 0.75) return 'white';
    if (r < 0.95) return 'green';
    return 'blue';
  }

  function rollCraftQuality() {
    const r = Math.random();
    if (r < 0.6) return 'ç™½è‰²'; // å·²åºŸå¼ƒï¼Œåªä¿ç•™æ¥å£å…¼å®¹
  }

  // -----------------------
  // åœ°å›¾åœ°ç‚¹å®šä¹‰
  // -----------------------
  const MapLocations = {
    residential: {
      key: 'residential',
      name: 'é™„è¿‘ä½å®…åŒº',
      minutes: 40,
      baseDanger: 'ä½',
      lootHint: 'åŸºç¡€é£Ÿç‰© / ææ–™'
    },
    supermarket: {
      key: 'supermarket',
      name: 'åºŸå¼ƒè¶…å¸‚',
      minutes: 60,
      baseDanger: 'ä¸­',
      lootHint: 'å¤§é‡é£Ÿç‰© / æ°´'
    },
    hospital: {
      key: 'hospital',
      name: 'åºŸå¼ƒåŒ»é™¢',
      minutes: 75,
      baseDanger: 'ä¸­',
      lootHint: 'åŒ»ç–—ç‰©èµ„'
    },
    factory: {
      key: 'factory',
      name: 'å·¥ä¸šåŒº',
      minutes: 90,
      baseDanger: 'é«˜',
      lootHint: 'é‡‘å± / ææ–™'
    }
  };

  // -----------------------
  // å®¶å…·å®šä¹‰
  // -----------------------
  const FurnitureDefs = [
    { key: 'bed',        name: 'åºŠ',       desc: 'å¯ä»¥ç¡è§‰æ¢å¤ä½“åŠ›ã€‚' },
    { key: 'workbench',  name: 'å·¥å…·å°',   desc: 'ç”¨äºåŠ å·¥æ­¦å™¨å’Œææ–™ã€‚' },
    { key: 'stove',      name: 'ç¶å°',     desc: 'å¯ä»¥çƒ¹é¥ªæ›´å¥½çš„é£Ÿç‰©ã€‚' },
    { key: 'medkit',     name: 'åŒ»ç–—ç®±',   desc: 'ç®€å•å¤„ç†ä¼¤å£å’Œç–¾ç—…ã€‚' },
    { key: 'barrel',     name: 'é…¿é…’æ¡¶',   desc: 'ç”¨äºé…¿é€ é…’ç²¾ï¼Œæå‡å£«æ°”ã€‚' },
    { key: 'fireplace',  name: 'å£ç‚‰',     desc: 'æä¾›å–æš–å’Œå°‘é‡çƒ¹é¥ªåŠŸèƒ½ã€‚' },
    { key: 'greenhouse', name: 'å°å‹æ¸©å®¤', desc: 'æŒç»­äº§å‡ºå°‘é‡é£Ÿæä¸è¯è‰ã€‚' }
  ];

  // -----------------------
  // åˆ¶é€ åˆ†ç±» & é…æ–¹å®šä¹‰
  // -----------------------
  const CraftCategories = {
    cooking: {
      key: 'cooking',
      name: 'çƒ¹é¥ª',
      short: 'æå‡é¥±è…¹ä¸å°‘é‡ HPã€‚',
      desc: 'ä½¿ç”¨åŸºç¡€é£Ÿç‰©åšæˆæ›´æ˜“ä¿å­˜ã€æ›´é«˜é¥±è…¹çš„æ–™ç†ã€‚',
      recipes: [
        {
          id: 'cook_meal',
          name: 'ç®€æ˜“çƒ­é£Ÿ',
          time: 60,
          cost: { food: 1, water: 0, materials: 0 },
          effect: { hunger: 25, hp: 5, morale: 2 },
          desc: 'æŠŠæ‰‹å¤´çš„é£ŸæåŠ çƒ­ï¼Œåšæˆä¸€ä»½çƒ­ä¹çš„ç®€æ˜“é¤ã€‚æ¢å¤é¥±è…¹ä¸å°‘é‡ HPã€‚'
        },
        {
          id: 'boil_water',
          name: 'ç…®æ²¸æ°´',
          time: 45,
          cost: { food: 0, water: 1, materials: 0 },
          effect: { thirst: 15, morale: 1 },
          desc: 'æŠŠå¯ç–‘çš„æ°´æºç…®æ²¸ï¼Œè‡³å°‘å£æ¸´çš„æ—¶å€™ä¸ç”¨å¤ªæ‹…å¿ƒä¼šé—¹è‚šå­ã€‚'
        }
      ]
    },
    medical: {
      key: 'medical',
      name: 'åˆ¶è¯',
      short: 'æ²»ç–—ä¼¤åŠ¿ï¼Œæå‡ç”Ÿå­˜ç‡ã€‚',
      desc: 'åˆ¶ä½œç»·å¸¦ä¸ç®€å•è¯ç‰©ï¼Œå‡å°‘ä¼¤åŠ¿å¸¦æ¥çš„é£é™©ã€‚',
      recipes: [
        {
          id: 'bandage',
          name: 'ç®€æ˜“ç»·å¸¦',
          time: 45,
          cost: { food: 0, water: 0, materials: 1 },
          effect: { hp: 10, morale: 1 },
          desc: 'ç”¨å¹²å‡€å¸ƒæ–™å’Œå°‘é‡è¯ç‰©åšæˆç®€å•ç»·å¸¦ï¼Œç¼“æ…¢æ¢å¤ HPã€‚'
        },
        {
          id: 'med_pack',
          name: 'å°å‹åŒ»ç–—åŒ…',
          time: 90,
          cost: { food: 0, water: 0, materials: 2 },
          effect: { hp: 25, morale: 2 },
          desc: 'å°†æ­¢è¡€å‰‚ã€ç»·å¸¦ä¸æ­¢ç—›è¯æ‰“åŒ…æˆä¸€ä¸ªå°åŒ»ç–—åŒ…ï¼Œåº”å¯¹æ›´ä¸¥é‡çš„ä¼¤åŠ¿ã€‚'
        }
      ]
    },
    processing: {
      key: 'processing',
      name: 'åŠ å·¥',
      short: 'æŠŠåŸææ–™åŠ å·¥ä¸ºæ›´å®ç”¨çš„ç‰©å“ã€‚',
      desc: 'é€šè¿‡å·¥å…·å°æŠŠæœ¨æå’Œé‡‘å±åŠ å·¥æˆç®€æ˜“æ­¦å™¨å’Œæ„ä»¶ã€‚',
      recipes: [
        {
          id: 'wood_stick',
          name: 'åˆ¶ä½œæœ¨æ£',
          time: 60,
          cost: { food: 0, water: 0, materials: 2 },
          effect: { },
          type: 'weapon',
          weaponBase: 'æœ¨æ£',
          weaponAtk: 3,
          weaponDur: 8,
          desc: 'ç”¨æœ¨æ¿å’Œé‡‘å±ç¢ç‰‡åšå‡ºä¸€æ ¹ç»“å®çš„æœ¨æ£ï¼Œå“è´¨æŒ‰å‡ ç‡éšæœºï¼ˆç™½/ç»¿/è“ï¼‰ã€‚'
        },
        {
          id: 'wood_plank',
          name: 'æœ¨æ¿å¼ºåŒ–ä»¶',
          time: 45,
          cost: { food: 0, water: 0, materials: 1 },
          effect: { materials: 1, morale: 1 },
          desc: 'æŠŠæ•£ä¹±çš„æœ¨æ–™åŠ å·¥æˆè§„åˆ™æœ¨æ¿ï¼Œä¾¿äºåç»­å»ºé€ å’ŒåŠ å›ºã€‚'
        }
      ]
    },
    brewing: {
      key: 'brewing',
      name: 'é…¿é…’',
      short: 'æå‡å£«æ°”ï¼Œä¹Ÿå¯èƒ½æœ‰å‰¯ä½œç”¨ã€‚',
      desc: 'åœ¨é…¿é…’æ¡¶é‡Œå‘é…µä¸€äº›ä¸œè¥¿ï¼Œåšå‡ºèƒ½è®©äººæš‚æ—¶å¿˜è®°ç—›è‹¦çš„ä¸œè¥¿ã€‚',
      recipes: [
        {
          id: 'light_brew',
          name: 'æ·¡é…’',
          time: 90,
          cost: { food: 1, water: 1, materials: 0 },
          effect: { morale: 10, thirst: -5 },
          desc: 'å‘é…µå‡ºæ¥çš„æ·¡é…’ï¼Œèƒ½æ˜æ˜¾æå‡å£«æ°”ï¼Œä½†ä¼šç¨å¾®åŠ é‡å£æ¸´ã€‚'
        }
      ]
    },
    farming: {
      key: 'farming',
      name: 'ç§æ¤',
      short: 'ä¸ºåŸºåœ°æä¾›é•¿æœŸè¡¥ç»™ã€‚',
      desc: 'åœ¨å°å‹æ¸©å®¤é‡Œå°è¯•ç§æ¤ä¸€äº›ä¸œè¥¿ï¼Œè™½ç„¶ç²—ç³™ï¼Œä½†æ€»æ¯”åä»¥å¾…æ¯™å¥½ã€‚',
      recipes: [
        {
          id: 'plant_veggies',
          name: 'ç§æ¤è”¬èœ',
          time: 60,
          cost: { food: 0, water: 1, materials: 1 },
          effect: { food: 2, morale: 2 },
          desc: 'ç®€å•çš„åœŸåŸ¹è”¬èœï¼Œå…ˆæŠ•å…¥ä¸€ç‚¹èµ„æºï¼Œç¨åèƒ½æ”¶è·å¯è§‚çš„é£Ÿç‰©ï¼ˆåŸå‹ä¸­ç«‹å³ç»“ç®—ï¼‰ã€‚'
        }
      ]
    }
  };

  // -----------------------
  // æ¸¸æˆçŠ¶æ€
  // -----------------------
  const GameState = {
    uiMode: 'home',

    day: 1,
    hour: 7,
    minute: 0,

    hp: 100,
    maxHp: 100,

    hunger: 80,
    thirst: 80,
    fatigue: 80,

    food: 5,
    water: 5,
    materials: 6,
    ammo: 5,
    morale: 50,

    alive: true,
    logExtra: '',

    weaponInventory: [],
    equippedWeaponIndex: -1,

    lastHungerMsgLevel: null,
    lastThirstMsgLevel: null,
    lastFatigueMsgLevel: null,

    selectedLocationKey: null,
    craftCategoryKey: null,

    furniture: {}
  };

  // -----------------------
  // DOM å·¥å…·
  // -----------------------
  function q(id) { return document.getElementById(id); }

  function formatTime() {
    const hh = String(GameState.hour).padStart(2, '0');
    const mm = String(GameState.minute).padStart(2, '0');
    return `${hh}:${mm}`;
  }

  function updateStatus() {
    const s = `
      <span class="label">å¤©æ•°</span>${GameState.day}
      &emsp;<span class="label">æ—¶é—´</span>${formatTime()}
      &emsp;<span class="label">HP</span>${GameState.hp}/${GameState.maxHp}
      &emsp;<span class="label">é¥±è…¹</span>${Math.round(GameState.hunger)}
      &emsp;<span class="label">æ°´åˆ†</span>${Math.round(GameState.thirst)}
      &emsp;<span class="label">ä½“åŠ›</span>${Math.round(GameState.fatigue)}
      <br>
      <span class="label">é£Ÿç‰©</span>${GameState.food}
      &emsp;<span class="label">æ°´</span>${GameState.water}
      &emsp;<span class="label">ææ–™</span>${GameState.materials}
      &emsp;<span class="label">å¼¹è¯</span>${GameState.ammo}
      &emsp;<span class="label">å£«æ°”</span>${GameState.morale}
    `;
    q('status').innerHTML = s;
  }

  function updateMapStatus() {
    const nightWarning = GameState.hour >= 21
      ? 'å¤œæ·±äº†ï¼Œä¸§å°¸ä»¬å¼€å§‹èºåŠ¨ï¼Œå¤–å‡ºé£é™©æå‡ã€‚'
      : 'ç™½å¤©/å‚æ™šï¼Œå¤–å‡ºç›¸å¯¹å®‰å…¨ã€‚';

    const text = `
      <span class="label">å¤©æ•°</span>${GameState.day}
      &emsp;<span class="label">æ—¶é—´</span>${formatTime()}
      &emsp;<span class="label">HP</span>${GameState.hp}/${GameState.maxHp}
      <br>
      <span class="label">é¥±è…¹</span>${Math.round(GameState.hunger)}
      &emsp;<span class="label">æ°´åˆ†</span>${Math.round(GameState.thirst)}
      &emsp;<span class="label">ä½“åŠ›</span>${Math.round(GameState.fatigue)}
      <br>${nightWarning}
    `;
    q('mapStatus').innerHTML = text;
  }

  function updateCraftStatus() {
    const text = `
      <span class="label">å¤©æ•°</span>${GameState.day}
      &emsp;<span class="label">æ—¶é—´</span>${formatTime()}
      &emsp;<span class="label">HP</span>${GameState.hp}/${GameState.maxHp}
      <br>
      <span class="label">é¥±è…¹</span>${Math.round(GameState.hunger)}
      &emsp;<span class="label">æ°´åˆ†</span>${Math.round(GameState.thirst)}
      &emsp;<span class="label">ä½“åŠ›</span>${Math.round(GameState.fatigue)}
      &emsp;<span class="label">å£«æ°”</span>${Math.round(GameState.morale)}
    `;
    q('craftStatus').innerHTML = text;
  }

  function setLog(text) {
    q('log').textContent = text;
  }

  function pushLog(text) {
    q('log').textContent += '\n\n' + text;
  }

  function setChoices(buttons) {
    const box = q('choices');
    box.innerHTML = '';
    buttons.forEach(cfg => {
      const btn = document.createElement('button');
      btn.textContent = cfg.text;
      btn.onclick = cfg.onClick;
      box.appendChild(btn);
    });
  }

  // -----------------------
  // æ­¦å™¨ç›¸å…³
  // -----------------------
  function createWeapon(baseName, baseAtk, baseDur, qualityKey, type) {
    const qInfo = Qualities[qualityKey];
    return {
      name: baseName,
      type,
      qualityKey,
      atk: baseAtk + qInfo.atkBonus,
      maxDur: baseDur + qInfo.durBonus,
      dur: baseDur + qInfo.durBonus
    };
  }

  function addWeaponToInventory(weapon) {
    GameState.weaponInventory.push(weapon);
    if (GameState.equippedWeaponIndex === -1) {
      GameState.equippedWeaponIndex = 0;
    }
    updateWeaponPanel();
    updateInventoryPanel();
  }

  function describeWeapon(w) {
    const qInfo = Qualities[w.qualityKey];
    return `[${qInfo.name}] ${w.name} (ATK ${w.atk}, è€ä¹… ${w.dur}/${w.maxDur})`;
  }

  function updateWeaponPanel() {
    const panel = q('weaponPanel');
    let html = '<h2>æ­¦å™¨ & è£…å¤‡</h2>';

    if (GameState.weaponInventory.length === 0) {
      html += '<div>ä½ ç°åœ¨æ²¡æœ‰ä»»ä½•æ­¦å™¨ï¼Œåªèƒ½å¾’æ‰‹æˆ˜æ–—ï¼ˆATK 1ï¼‰ã€‚</div>';
    } else {
      html += '<div><strong>å½“å‰æ­¦å™¨ï¼š</strong><br>';
      const idx = GameState.equippedWeaponIndex;
      const w = GameState.weaponInventory[idx];
      const qInfo = Qualities[w.qualityKey];
      html += `<span class="${qInfo.colorClass}">${describeWeapon(w)}</span></div>`;
      html += '<div style="margin-top:4px;"><strong>èƒŒåŒ…æ­¦å™¨ï¼š</strong></div>';
      html += '<ul style="padding-left:18px;margin:4px 0;">';
      GameState.weaponInventory.forEach((wep, i) => {
        const info = Qualities[wep.qualityKey];
        const marker = (i === idx) ? 'â˜… ' : '';
        html += `<li class="${info.colorClass}" style="cursor:pointer;" onclick="equipWeapon(${i})">${marker}${describeWeapon(wep)}</li>`;
      });
      html += '</ul>';
    }

    panel.innerHTML = html;
  }

  window.equipWeapon = function (index) {
    if (index >= 0 && index < GameState.weaponInventory.length) {
      GameState.equippedWeaponIndex = index;
      pushLog(`ä½ è£…å¤‡äº† ${describeWeapon(GameState.weaponInventory[index])}`);
      updateWeaponPanel();
      updateInventoryPanel();
    }
  };

  function getCurrentAtk() {
    const idx = GameState.equippedWeaponIndex;
    if (idx === -1) return 1;
    const w = GameState.weaponInventory[idx];
    return w.atk;
  }

  function damageWeapon() {
    const idx = GameState.equippedWeaponIndex;
    if (idx === -1) return;
    const w = GameState.weaponInventory[idx];
    w.dur -= 1;
    if (w.dur <= 0) {
      pushLog(`${w.name} å·²ç»æŸåï¼Œæ— æ³•ç»§ç»­ä½¿ç”¨ã€‚`);
      GameState.weaponInventory.splice(idx, 1);
      if (GameState.weaponInventory.length === 0) {
        GameState.equippedWeaponIndex = -1;
      } else {
        GameState.equippedWeaponIndex = 0;
      }
    }
    updateWeaponPanel();
    updateInventoryPanel();
  }

  // -----------------------
  // èƒŒåŒ…ç½‘æ ¼
  // -----------------------
  const InventoryInfo = {
    food:   { icon: 'ğŸ', name: 'é£Ÿç‰©', desc: 'å¯ä»¥æ¢å¤é¥±è…¹åº¦ï¼Œå¹¶ç¨å¾®å›å¤ HPã€‚' },
    water:  { icon: 'ğŸ’§', name: 'æ°´', desc: 'å¯ä»¥æ¢å¤æ°´åˆ†ï¼Œè®©ä½ ä¿æŒæ¸…é†’ã€‚' },
    mat:    { icon: 'ğŸªµ', name: 'ææ–™', desc: 'æœ¨æå’ŒåºŸé‡‘å±ï¼Œç”¨äºåˆ¶ä½œæ­¦å™¨ä¸ä¿®ç†ã€‚' },
    ammo:   { icon: 'ğŸ’¥', name: 'å¼¹è¯', desc: 'ç”¨äºè¿œç¨‹æ­¦å™¨ï¼Œç›®å‰ä»…ç”¨äºå ä½ã€‚' },
    weapon: { icon: 'âš”ï¸', name: 'æ­¦å™¨æ‘˜è¦', desc: 'æ˜¾ç¤ºä½ å½“å‰æ‹¥æœ‰çš„æ­¦å™¨æ¦‚å†µã€‚' }
  };

  function showInventoryDetail(key) {
    const info = InventoryInfo[key];
    if (!info) return;
    let extra = '';
    if (key === 'weapon') {
      if (GameState.weaponInventory.length === 0) {
        extra = 'ä½ è¿˜æ²¡æœ‰ä»»ä½•æ­¦å™¨ã€‚';
      } else {
        extra = 'ä½ æ‹¥æœ‰çš„æ­¦å™¨ï¼š\n' + GameState.weaponInventory.map(describeWeapon).join('\n');
      }
    }
    q('inventoryDetailText').textContent = info.desc + (extra ? '\n' + extra : '');
  }

  function updateInventoryPanel() {
    const panel = q('inventoryPanel');
    let html = '<h2>èƒŒåŒ…</h2>';
    html += '<div class="inventory-grid">';

    const items = [];

    if (GameState.food > 0) {
      items.push({ key: 'food', count: GameState.food });
    }
    if (GameState.water > 0) {
      items.push({ key: 'water', count: GameState.water });
    }
    if (GameState.materials > 0) {
      items.push({ key: 'mat', count: GameState.materials });
    }
    if (GameState.ammo > 0) {
      items.push({ key: 'ammo', count: GameState.ammo });
    }
    items.push({ key: 'weapon', count: GameState.weaponInventory.length });

    if (items.length === 0) {
      html += '<div class="inventory-item">èƒŒåŒ…æ˜¯ç©ºçš„ã€‚</div>';
    } else {
      items.forEach(item => {
        const info = InventoryInfo[item.key];
        html += `
          <div class="inventory-item" onclick="showInventoryDetail('${item.key}')">
            <div class="inventory-icon">${info.icon}</div>
            <div>${info.name}</div>
            <div>x${item.count}</div>
          </div>
        `;
      });
    }

    html += '</div><div id="inventoryDetailText" class="inv-detail">ç‚¹å‡»ç‰©å“æŸ¥çœ‹è¯´æ˜ã€‚</div>';
    panel.innerHTML = html;
  }

  window.showInventoryDetail = showInventoryDetail;

  // -----------------------
  // å®¶å…· & åˆ¶é€ é¢æ¿
  // -----------------------
  function updateFurniturePanel() {
    const panel = q('furniturePanel');
    let html = '<h2>å®¶å…·</h2>';
    html += '<div class="furniture-grid">';
    FurnitureDefs.forEach(f => {
      const unlocked = !!GameState.furniture[f.key];
      const locked = !unlocked && f.key !== 'bed';
      const classes = 'furniture-item' + (locked ? ' furniture-locked' : '');
      const label = locked ? `${f.name}ï¼ˆæœªåˆ¶é€ ï¼‰` : f.name;
      html += `
        <div class="${classes}" onclick="clickFurniture('${f.key}')">
          <div>${label}</div>
        </div>
      `;
    });
    html += '</div>';
    panel.innerHTML = html;
  }

  window.clickFurniture = function (key) {
    const unlocked = !!GameState.furniture[key];
    const def = FurnitureDefs.find(f => f.key === key);
    if (!def) return;
    if (!unlocked && key !== 'bed') {
      pushLog(`ä½ çœ‹ç€ ${def.name} åº”è¯¥åœ¨çš„ä½ç½®â€”â€”ä¹Ÿè®¸å“ªå¤©èƒ½æŠŠå®ƒé€ å‡ºæ¥ã€‚`);
    } else if (key === 'bed') {
      pushLog('ä½ èººåœ¨åºŠä¸Šç¨å¾®æ”¾ç©ºäº†ä¸€ä¼šå„¿ï¼Œè™½ç„¶æ²¡çœŸæ­£ç¡ç€ï¼Œä½†å¿ƒæƒ…å¥½äº†ç‚¹ã€‚');
      GameState.morale = Math.min(100, GameState.morale + 2);
    } else {
      pushLog(`ä½ æ£€æŸ¥äº†ä¸€ä¸‹ ${def.name}ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰ç‰¹åˆ«è¦åšçš„äº‹æƒ…ã€‚`);
    }
    updateStatus();
  };

  function updateCraftPanel() {
    const panel = q('craftPanel');
    let html = '<h2>åˆ¶é€ </h2>';
    html += '<div class="craft-grid">';
    Object.values(CraftCategories).forEach(cat => {
      html += `
        <div class="craft-item" onclick="openCraftCategory('${cat.key}')">
          <div class="craft-item-title">${cat.name}</div>
          <div class="craft-item-desc">${cat.short || ''}</div>
        </div>
      `;
    });
    html += '</div>';
    panel.innerHTML = html;
  }

  // -----------------------
  // æ—¶é—´ & çŠ¶æ€ æ¶ˆè€—
  // -----------------------
  function advanceTime(minutes) {
    if (minutes <= 0) return;
    const hours = minutes / 60;

    let totalMinutes = GameState.day * 24 * 60 + GameState.hour * 60 + GameState.minute + minutes;
    GameState.day = Math.floor(totalMinutes / (24 * 60));
    totalMinutes = totalMinutes % (24 * 60);
    GameState.hour = Math.floor(totalMinutes / 60);
    GameState.minute = totalMinutes % 60;

    GameState.hunger -= 3 * hours;
    GameState.thirst -= 4 * hours;

    GameState.hunger = Math.max(0, Math.min(100, GameState.hunger));
    GameState.thirst = Math.max(0, Math.min(100, GameState.thirst));

    checkVitalMessages();
  }

  function changeFatigue(delta) {
    GameState.fatigue += delta;
    GameState.fatigue = Math.max(0, Math.min(100, GameState.fatigue));
    checkVitalMessages();
  }

  function checkVitalMessages() {
    const h = GameState.hunger;
    let levelH = 0;
    if (h <= 30) levelH = 3;
    else if (h <= 50) levelH = 2;
    else if (h >= 100) levelH = 4;
    else if (h > 50) levelH = 1;

    if (levelH !== GameState.lastHungerMsgLevel) {
      if (levelH === 4) {
        pushLog('ä½ æ‰“äº†ä¸ªé¥±å—ï¼Œè§‰å¾—å¾ˆæ»¡è¶³ã€‚');
      } else if (levelH === 2) {
        pushLog('ä½ çš„èƒƒå¼€å§‹æŠ—è®®ï¼Œä¹Ÿè®¸è¯¥åƒç‚¹ä¸œè¥¿äº†ã€‚');
      } else if (levelH === 3) {
        pushLog('ä½ å·²ç»é¥¿å¾—å¤´æ˜çœ¼èŠ±ï¼Œå†ä¸åƒç‚¹ä¸œè¥¿å°±æ’‘ä¸ä½äº†ã€‚');
      }
      GameState.lastHungerMsgLevel = levelH;
    }

    const t = GameState.thirst;
    let levelT = 0;
    if (t <= 30) levelT = 3;
    else if (t <= 50) levelT = 2;
    else if (t >= 100) levelT = 4;
    else if (t > 50) levelT = 1;

    if (levelT !== GameState.lastThirstMsgLevel) {
      if (levelT === 4) {
        pushLog('ä½ æŠ¹äº†æŠ¹å˜´è§’çš„æ°´æ¸ï¼Œæ„Ÿè§‰æµ‘èº«èˆ’ç•…ã€‚');
      } else if (levelT === 2) {
        pushLog('å–‰å’™æœ‰ç‚¹å‘å¹²ï¼Œä¹Ÿè®¸è¯¥å–ç‚¹æ°´äº†ã€‚');
      } else if (levelT === 3) {
        pushLog('ä½ çš„å–‰å’™åƒè¢«ç ‚çº¸æ“¦è¿‡ï¼Œå†ä¸å–æ°´å°±è¦è„±æ°´äº†ã€‚');
      }
      GameState.lastThirstMsgLevel = levelT;
    }

    const f = GameState.fatigue;
    let levelF = 0;
    if (f <= 30) levelF = 3;
    else if (f <= 50) levelF = 2;
    else if (f >= 100) levelF = 4;
    else if (f > 50) levelF = 1;

    if (levelF !== GameState.lastFatigueMsgLevel) {
      if (levelF === 4) {
        pushLog('ä½ æ´»åŠ¨äº†ä¸€ä¸‹æ‰‹è„šï¼Œç²¾ç¥ä¸é”™ã€‚');
      } else if (levelF === 2) {
        pushLog('ä½ å¼€å§‹æ„Ÿè§‰æœ‰ç‚¹ç´¯äº†ï¼Œä¹Ÿè®¸è¯¥ä¼‘æ¯ä¸€ä¸‹ã€‚');
      } else if (levelF === 3) {
        pushLog('ä½ çš„èº«ä½“åƒè¢«çŒäº†é“…ï¼Œå†ä¸ç¡ä¸€è§‰å°±é¡¶ä¸ä½äº†ã€‚');
      }
      GameState.lastFatigueMsgLevel = levelF;
    }
  }

  function applyStarvationDamage() {
    let dmg = 0;
    if (GameState.hunger <= 0) dmg += 4;
    else if (GameState.hunger <= 20) dmg += 2;

    if (GameState.thirst <= 0) dmg += 6;
    else if (GameState.thirst <= 20) dmg += 3;

    if (GameState.fatigue <= 0) dmg += 4;
    else if (GameState.fatigue <= 20) dmg += 2;

    if (dmg > 0) {
      GameState.hp -= dmg;
      pushLog(`ç”±äºæåº¦çš„é¥¥é¥¿ã€å£æ¸´æˆ–ç–²åŠ³ï¼Œä½ é¢å¤–å¤±å»äº† ${dmg} ç‚¹ HPã€‚`);
    }
  }

  // -----------------------
  // æ¸¸æˆæµç¨‹ï¼šåŸºåœ°ç•Œé¢
  // -----------------------
  function enterBase(first = false) {
    GameState.uiMode = 'home';
    q('homeScreen').style.display = 'block';
    q('mapScreen').style.display = 'none';
    q('craftScreen').style.display = 'none';

    updateStatus();
    updateWeaponPanel();
    updateInventoryPanel();
    updateFurniturePanel();
    updateCraftPanel();

    let text = '';
    if (first) {
      text += 'ä¸–ç•Œå·²ç»å´©æºƒã€‚ä½ åœ¨ä¸€é—´å‹‰å¼ºèƒ½æŒ¡é£é®é›¨çš„é¿éš¾æ‰€é‡Œé†’æ¥ï¼Œå¤–é¢å¶å°”ä¼ æ¥é›¶æ˜Ÿçš„åšå«å£°ã€‚\n';
      text += 'ç°åœ¨æ˜¯ Day 1 Â· 07:00ï¼Œä½ éœ€è¦é£Ÿç‰©ã€æ°´ï¼Œè¿˜æœ‰ä¸€ä»¶åƒæ ·çš„æ­¦å™¨ï¼Œæ‰èƒ½åœ¨è¿™ä¸ªä¸–ç•Œæ´»ä¸‹å»ã€‚';
    } else {
      text += 'ä½ å›åˆ°é¿éš¾æ‰€ï¼Œå…³ä¸Šé—¨ï¼Œå–˜äº†å£æ°”ã€‚è‡³å°‘è¿™é‡Œæš‚æ—¶è¿˜ç®—å®‰å…¨ã€‚';
    }
    if (GameState.logExtra) {
      text += '\n\n' + GameState.logExtra;
      GameState.logExtra = '';
    }
    setLog(text);

    setChoices([
      { text: 'ğŸ—º å‡ºé—¨å‰å¾€åœ°å›¾', onClick: openMap },
      { text: 'âš”ï¸ å»é™„è¿‘æ¸…ç†ä¸§å°¸ï¼ˆ1 å°æ—¶ï¼‰', onClick: fightZombie },
      { text: 'ğŸ åƒç‚¹ä¸œè¥¿', onClick: eatFood },
      { text: 'ğŸ’§ å–æ°´', onClick: drinkWater },
      { text: 'ğŸ› ç¡è§‰ 8 å°æ—¶', onClick: sleepEightHours }
    ]);
  }

  function fightZombie() {
    advanceTime(60);
    changeFatigue(-10);

    let text = 'ä½ åœ¨ç ´è´¥çš„è¡—é“ä¸Šé‡åˆ°äº†ä¸€åªä¸§å°¸ã€‚\n';
    const enemyHpMax = 12 + Math.floor(Math.random() * 8);
    let enemyHp = enemyHpMax;

    const atk = getCurrentAtk();
    const enemyAtk = 4 + Math.floor(Math.random() * 3);

    enemyHp -= atk;
    damageWeapon();
    text += `ä½ å…ˆå‡ºæ‰‹ï¼Œå¯¹ä¸§å°¸é€ æˆäº† ${atk} ç‚¹ä¼¤å®³ã€‚\n`;

    if (enemyHp <= 0) {
      GameState.morale += 3;
      text += 'ä¸§å°¸å€’åœ¨åœ°ä¸Šï¼Œä¸å†åŠ¨å¼¹ã€‚\n';
      const r = Math.random();
      if (r < 0.4) {
        GameState.food += 1;
        text += 'ä½ ä»é™„è¿‘ç¿»å‡ºäº†ä¸€ç‚¹é£Ÿç‰©ã€‚';
      } else if (r < 0.7) {
        const qk = rollDropQuality();
        const w = createWeapon('ç®€æ˜“é“æ£’', 4, 10, qk, 'melee');
        addWeaponToInventory(w);
        text += `ä½ ä»å°¸ä½“é™„è¿‘æ‰¾åˆ°äº†ä¸€æ ¹é“æ£’ï¼š${describeWeapon(w)}`;
      } else {
        text += 'è¿™æ¬¡æ²¡ä»€ä¹ˆæˆ˜åˆ©å“ã€‚';
      }
      checkStateAndReturn(text);
      return;
    }

    GameState.hp -= enemyAtk;
    text += `ä¸§å°¸å‘ä½ æ‰‘æ¥ï¼Œä½ å—åˆ°äº† ${enemyAtk} ç‚¹ä¼¤å®³ã€‚`;

    if (GameState.hp <= 0) {
      GameState.hp = 0;
      enterGameOver(text + '\n\nä½ å€’åœ¨åœ°ä¸Šï¼Œå†ä¹Ÿçˆ¬ä¸èµ·æ¥ã€‚');
      return;
    }

    checkStateAndReturn(text);
  }

  function eatFood() {
    if (GameState.food <= 0) {
      checkStateAndReturn('ä½ ç¿»éäº†è§’è½ï¼Œä¹Ÿæ²¡æ‰¾åˆ°å¤šä½™çš„é£Ÿç‰©ã€‚');
      return;
    }
    GameState.food -= 1;
    GameState.hunger = Math.min(100, GameState.hunger + 30);
    GameState.hp = Math.min(GameState.maxHp, GameState.hp + 5);
    GameState.morale += 2;
    checkVitalMessages();
    checkStateAndReturn('ä½ åƒæ‰äº†ä¸€ä»½é£Ÿç‰©ï¼Œæ„Ÿè§‰èƒƒé‡Œæš–å’Œäº†ä¸€äº›ã€‚');
  }

  function drinkWater() {
    if (GameState.water <= 0) {
      checkStateAndReturn('æ°´å£¶æ˜¯ç©ºçš„ï¼Œä½ åªèƒ½èˆ”èˆ”å¹²è£‚çš„å˜´å”‡ã€‚');
      return;
    }
    GameState.water -= 1;
    GameState.thirst = Math.min(100, GameState.thirst + 30);
    GameState.morale += 1;
    checkVitalMessages();
    checkStateAndReturn('ä½ å°å£åœ°å–äº†ç‚¹æ°´ï¼Œè®©è„‘å­æ¸…é†’äº†ä¸€äº›ã€‚');
  }

  function sleepEightHours() {
    advanceTime(480);
    changeFatigue(+40);
    GameState.morale += 5;
    checkStateAndReturn('ä½ æ‰¾äº†ä¸ªç›¸å¯¹å®‰å…¨çš„è§’è½ï¼Œç¡äº†å¤§çº¦å…«ä¸ªå°æ—¶ã€‚é†’æ¥æ—¶ï¼Œè„‘å­æ¸…é†’äº†ä¸€äº›ï¼Œä½†è‚šå­æ›´é¥¿äº†ã€‚');
  }

  function checkStateAndReturn(extraText) {
    applyStarvationDamage();

    if (GameState.hp <= 0) {
      GameState.hp = 0;
      enterGameOver(extraText + '\n\nä½ å†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚');
      return;
    }
    GameState.logExtra = extraText;
    enterBase(false);
  }

  function enterGameOver(text) {
    GameState.alive = false;
    updateStatus();
    setLog(text + '\n\nâ€”â€” æ¸¸æˆç»“æŸ â€”â€”');
    setChoices([
      { text: 'é‡æ–°å¼€å§‹', onClick: () => restart() }
    ]);
  }

  function restart() {
    GameState.uiMode = 'home';
    GameState.day = 1;
    GameState.hour = 7;
    GameState.minute = 0;

    GameState.hp = 100;
    GameState.maxHp = 100;

    GameState.hunger = 80;
    GameState.thirst = 80;
    GameState.fatigue = 80;

    GameState.food = 5;
    GameState.water = 5;
    GameState.materials = 6;
    GameState.ammo = 5;
    GameState.morale = 50;

    GameState.alive = true;
    GameState.weaponInventory = [];
    GameState.equippedWeaponIndex = -1;
    GameState.logExtra = '';

    GameState.lastHungerMsgLevel = null;
    GameState.lastThirstMsgLevel = null;
    GameState.lastFatigueMsgLevel = null;

    GameState.selectedLocationKey = null;
    GameState.craftCategoryKey = null;

    GameState.furniture = {
      bed: true,
      workbench: false,
      stove: false,
      medkit: false,
      barrel: false,
      fireplace: false,
      greenhouse: false
    };

    q('metaPanel').innerHTML =
      '<h2>æœ¬å±€ä¿¡æ¯</h2><div>åç»­è¿™é‡Œå¯ä»¥æ¥å…¥â€œæ­»äº¡å¾ªç¯ / æ°¸ä¹…å¢ç›Š / æˆå°±è§£é”â€ç­‰ç³»ç»Ÿã€‚</div>';
    enterBase(true);
  }

  // -----------------------
  // åœ°å›¾ç•Œé¢é€»è¾‘
  // -----------------------
  function openMap() {
    GameState.uiMode = 'map';
    q('homeScreen').style.display = 'none';
    q('mapScreen').style.display = 'block';
    q('craftScreen').style.display = 'none';

    updateMapStatus();
    q('mapLocationDetail').textContent = 'ç‚¹å‡»å·¦ä¾§ä»»æ„åœ°ç‚¹æŸ¥çœ‹è¯¦æƒ…ã€‚';
    GameState.selectedLocationKey = null;
  }

  function backToBase() {
    enterBase(false);
  }

  function dangerWithNight(baseDanger) {
    if (GameState.hour >= 21) {
      if (baseDanger === 'ä½') return 'ä¸­ï¼ˆå¤œæ™šåŠ æˆï¼‰';
      if (baseDanger === 'ä¸­') return 'é«˜ï¼ˆå¤œæ™šåŠ æˆï¼‰';
      return 'æé«˜ï¼ˆå¤œæ™šåŠ æˆï¼‰';
    }
    return baseDanger;
  }

  function selectLocation(key) {
    const loc = MapLocations[key];
    GameState.selectedLocationKey = key;
    const danger = dangerWithNight(loc.baseDanger);
    const text =
      `ã€${loc.name}ã€‘\n` +
      `é¢„è®¡å¾€è¿”è€—æ—¶ï¼šçº¦ ${loc.minutes} åˆ†é’Ÿ\n` +
      `å±é™©ç¨‹åº¦ï¼š${danger}\n` +
      `ä¸»è¦èµ„æºï¼š${loc.lootHint}\n\n` +
      `ç‚¹å‡»â€œå‡ºå‘å‰å¾€â€å¼€å§‹è¿™æ¬¡è¡ŒåŠ¨ã€‚`;
    q('mapLocationDetail').textContent = text;
  }

  function startTravel() {
    if (!GameState.selectedLocationKey) {
      q('mapLocationDetail').textContent = 'è¯·å…ˆåœ¨å·¦ä¾§é€‰æ‹©ä¸€ä¸ªåœ°ç‚¹ã€‚';
      return;
    }
    const loc = MapLocations[GameState.selectedLocationKey];
    const beforeNight = GameState.hour >= 21;
    const minutes = loc.minutes;
    advanceTime(minutes);
    changeFatigue(-minutes / 6);

    let log = `ä½ ç¦»å¼€é¿éš¾æ‰€ï¼Œå‰å¾€ã€${loc.name}ã€‘ã€‚\n`;
    const atNight = GameState.hour >= 21 || beforeNight;
    const r = Math.random();

    const enemyBonus = atNight ? 0.15 : 0;
    if (r < 0.25) {
      GameState.food += 1;
      GameState.water += (loc.key === 'supermarket') ? 1 : 0;
      log += 'ä½ åœ¨åºŸå¼ƒçš„è§’è½é‡Œç¿»å‡ºäº†äº›è¿˜èƒ½åƒå–çš„ä¸œè¥¿ã€‚';
    } else if (r < 0.5) {
      const addMat = loc.key === 'factory' ? 3 : 2;
      GameState.materials += addMat;
      log += 'ä½ åœ¨ç ´æŸçš„è®¾æ–½ä¸­æ‹†ä¸‹äº†ä¸€äº›ææ–™ã€‚';
    } else if (r < 0.7 + enemyBonus) {
      log += resolveMapZombieEncounter(loc, atNight);
    } else {
      log += 'ä½ å°å¿ƒç¿¼ç¿¼åœ°æœç´¢äº†ä¸€åœˆï¼Œä½†è¿™æ¬¡ä¼¼ä¹å¹¶æ²¡æœ‰å¤ªå¤šæ”¶è·ã€‚';
    }

    q('homeScreen').style.display = 'block';
    q('mapScreen').style.display = 'none';
    checkStateAndReturn(log);
  }

  function resolveMapZombieEncounter(loc, atNight) {
    let text = '';
    const atk = getCurrentAtk();
    let enemyHp = 10 + Math.floor(Math.random() * 6);
    if (atNight) enemyHp += 4;

    const enemyAtk = atNight ? 6 : 4;
    text += `åœ¨ ${loc.name} é™„è¿‘ï¼Œä½ è¢«ä¸€åªä¸§å°¸å µåœ¨äº†é˜´æš—çš„è§’è½ã€‚\n`;

    enemyHp -= atk;
    damageWeapon();
    text += `ä½ å…ˆå‡ºæ‰‹ï¼Œå¯¹ä¸§å°¸é€ æˆäº† ${atk} ç‚¹ä¼¤å®³ã€‚\n`;

    if (enemyHp <= 0) {
      GameState.morale += 2;
      text += 'ä¸§å°¸è¢«ä½ å‡»å€’ï¼Œä¸å†åŠ¨å¼¹ã€‚\n';
      if (Math.random() < 0.4) {
        const qk = rollDropQuality();
        const w = createWeapon('æŸåçš„æ­¦å™¨', 3, 6, qk, 'melee');
        addWeaponToInventory(w);
        text += `ä½ ä»é™„è¿‘æ¡èµ·äº†ä¸€ä»¶è¿˜èƒ½ç”¨çš„æ­¦å™¨ï¼š${describeWeapon(w)}\n`;
      }
      return text;
    }

    GameState.hp -= enemyAtk;
    text += `ä¸§å°¸å‡¶ç‹ åœ°åæ‰‘ï¼Œä½ å—åˆ°äº† ${enemyAtk} ç‚¹ä¼¤å®³ã€‚\n`;
    if (GameState.hp <= 0) {
      GameState.hp = 0;
      enterGameOver(text + '\n\nä½ å€’åœ¨åœ°ä¸Šï¼Œå†ä¹Ÿçˆ¬ä¸èµ·æ¥ã€‚');
      return '';
    }
    return text;
  }

  window.selectLocation = selectLocation;
  window.startTravel = startTravel;
  window.backToBase = backToBase;

  // -----------------------
  // åˆ¶é€ ç•Œé¢é€»è¾‘
  // -----------------------
  function openCraftCategory(key) {
    const cat = CraftCategories[key];
    if (!cat) return;
    GameState.craftCategoryKey = key;
    GameState.uiMode = 'craft';

    q('homeScreen').style.display = 'none';
    q('mapScreen').style.display = 'none';
    q('craftScreen').style.display = 'block';

    renderCraftScreen();
  }
  window.openCraftCategory = openCraftCategory;

  function renderCraftScreen() {
    const cat = CraftCategories[GameState.craftCategoryKey];
    if (!cat) return;
    updateCraftStatus();
    q('craftTitle').textContent = `åˆ¶é€  - ${cat.name}`;
    q('craftSubtitle').textContent = cat.desc || '';
    q('craftCategoryName').textContent = `${cat.name} é…æ–¹`;

    let html = '<div class="map-grid">';
    cat.recipes.forEach(r => {
      const cost = r.cost || {};
      html += `
        <div class="map-location">
          <div class="map-location-name">${r.name}</div>
          <div style="font-size:12px;">è€—æ—¶ï¼šç´„ ${r.time || 30} åˆ†é’Ÿ</div>
          <div style="font-size:12px;">æ¶ˆè€—ï¼šé£Ÿç‰© ${cost.food || 0} / æ°´ ${cost.water || 0} / ææ–™ ${cost.materials || 0}</div>
          <div style="font-size:12px; margin-top:4px;">${r.desc}</div>
          <div style="margin-top:6px;">
            <button onclick="craftRecipe('${r.id}')">åˆ¶ä½œ</button>
          </div>
        </div>
      `;
    });
    html += '</div>';
    q('craftList').innerHTML = html;
    q('craftDetail').textContent = 'é€‰æ‹©ä¸€ä¸ªé…æ–¹è¿›è¡Œåˆ¶ä½œï¼Œç»“æœä¼šåœ¨è¿™é‡Œæ˜¾ç¤ºã€‚';
  }

  function craftRecipe(id) {
    const cat = CraftCategories[GameState.craftCategoryKey];
    if (!cat) return;
    const recipe = cat.recipes.find(r => r.id === id);
    if (!recipe) return;

    const cost = recipe.cost || {};
    if (GameState.food < (cost.food || 0) ||
        GameState.water < (cost.water || 0) ||
        GameState.materials < (cost.materials || 0)) {
      q('craftDetail').textContent = 'ææ–™ä¸è¶³ï¼Œæ— æ³•åˆ¶ä½œè¿™é¡¹é…æ–¹ã€‚';
      return;
    }

    GameState.food      -= (cost.food || 0);
    GameState.water     -= (cost.water || 0);
    GameState.materials -= (cost.materials || 0);

    advanceTime(recipe.time || 30);
    changeFatigue(-(recipe.time || 30) / 10);

    let text = `ä½ å¼€å§‹è¿›è¡Œã€${recipe.name}ã€‘ã€‚\n${recipe.desc}\n`;

    const eff = recipe.effect || {};
    if (eff.hunger) {
      GameState.hunger = Math.min(100, GameState.hunger + eff.hunger);
      text += `é¥±è…¹ +${eff.hunger}ã€‚\n`;
    }
    if (eff.thirst) {
      GameState.thirst = Math.min(100, GameState.thirst + eff.thirst);
      text += `æ°´åˆ† +${eff.thirst}ã€‚\n`;
    }
    if (eff.hp) {
      GameState.hp = Math.min(GameState.maxHp, GameState.hp + eff.hp);
      text += `HP +${eff.hp}ã€‚\n`;
    }
    if (eff.morale) {
      GameState.morale = Math.min(100, GameState.morale + eff.morale);
      text += `å£«æ°” +${eff.morale}ã€‚\n`;
    }
    if (eff.food) {
      GameState.food += eff.food;
      text += `é£Ÿç‰© +${eff.food}ã€‚\n`;
    }

    if (recipe.type === 'weapon') {
      const quality = (function () {
        const r = Math.random();
        if (r < 0.6) return 'white';
        if (r < 0.9) return 'green';
        return 'blue';
      })();
      const w = createWeapon(recipe.weaponBase, recipe.weaponAtk, recipe.weaponDur, quality, 'melee');
      addWeaponToInventory(w);
      text += `ä½ æˆåŠŸåˆ¶ä½œäº†ä¸€ä»¶æ­¦å™¨ï¼š${describeWeapon(w)}\n`;
    }

    applyStarvationDamage();
    q('craftDetail').textContent = text;

    if (GameState.hp <= 0) {
      GameState.hp = 0;
      enterGameOver(text + '\n\nä½ å†ä¹Ÿæ’‘ä¸ä¸‹å»äº†ã€‚');
      return;
    }

    GameState.logExtra = text;
    enterBase(false);
  }
  window.craftRecipe = craftRecipe;

  function backFromCraft() {
    enterBase(false);
  }
  window.backFromCraft = backFromCraft;

  // -----------------------
  // å¯åŠ¨
  // -----------------------
  restart();
</script>
</body>
</html>
